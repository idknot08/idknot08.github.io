---
title: sample.bin
date: 2025-07-15 15:08:56 +0700
categories: [Malware Analysis, Reverse Engineering]
tags: [autoit, backdoor, wacatac, unpack, memory-dump]
description: PhÃ¢n tÃ­ch bÆ°á»›c Ä‘áº§u máº«u AutoIt `sample.bin` (rÃ¡p dáº¡ng Backdoor/Trojan.Agent.Wacatac) decompile AutoIt, bypass anti-debug, quan sÃ¡t VirtualAlloc + dump vÃ¹ng nhá»› Ä‘á»ƒ tiáº¿p tá»¥c giáº£i mÃ£.
---

# ğŸ” PhÃ¢n tÃ­ch máº«u `sample.bin` (AutoIt â€” Trojan.Agent / Backdoor) â€” tiáº¿p tá»¥c

**File**: `sample.bin`
**File type**: executable (AutoIt)
**MD5**: `66f33597cbf097345c51891ab951b641`
**VirusTotal**: Backdoor / Trojan.Agent.Wacatac

![VT detection](/resources/Sample-bin/Pasted%20image%2020251001150856.png)

---

## ğŸ§Š TÃ³m táº¯t bÆ°á»›c Ä‘Ã£ lÃ m (tá»« pháº§n báº¡n cung cáº¥p)

- XÃ¡c Ä‘á»‹nh: **AutoIt packed** (exe chá»©a script trong .rdata / .rsrc).
  ![ExeinfoPE](/resources/Sample-bin/Pasted%20image%2020251001151054.png)

- PeStudio liá»‡t kÃª nhiá»u cáº£nh bÃ¡o level 1 (embedded AutoIt script lá»›n trong .rdata/.rsrc, imports liÃªn quan máº¡ng/WMIC/Psapi/IpHelper...).
  ![PeStudio indicators](/resources/Sample-bin/Pasted%20image%2020251001152108.png)

- Trong resources cÃ³ `RCData` chá»©a script AutoIt â†’ dÃ¹ng `exe2aut` decompile ra `sample_.au3`. Má»Ÿ báº±ng Notepad++ tháº¥y script dÃ i, pháº§n mÃ£ chÃ­nh Ä‘Æ°á»£c **mÃ£ hoÃ¡/ghÃ©p chuá»—i** bá»Ÿi hÃ m `mdfzjnyhbr()` liÃªn tá»¥c ná»‘i `$j` vá»›i chÃ­nh nÃ³.
  ![Resource rcdata / script](/resources/Sample-bin/Pasted%20image%2020251001152224.png)
  ![Script snippet](/resources/Sample-bin/Pasted%20image%2020251001152806.png)
  ![Obfuscated concatenation function](/resources/Sample-bin/Pasted%20image%2020251001153616.png)

- Trong phÃ¢n tÃ­ch tÄ©nh/IDA: phÃ¡t hiá»‡n kiá»ƒm tra anti-debug `IsDebuggerPresent` táº¡i `sub_403b3a` (offset file: 0x2F7A). Khi cháº¡y, hÃ m tráº£ 1 â†’ chÆ°Æ¡ng trÃ¬nh thoÃ¡t. Ta Ä‘Ã£ Ä‘áº·t breakpoint vÃ  **sá»­a giÃ¡ trá»‹ tráº£ vá»** thÃ nh 0 Ä‘á»ƒ tiáº¿p tá»¥c phÃ¢n tÃ­ch.
  ![IsDebuggerPresent hit](/resources/Sample-bin/Pasted%20image%2020251001155457.png)
  ![Breakpoint & patch in x32dbg](/resources/Sample-bin/Pasted%20image%20202510011561251.png)

- Quan sÃ¡t hÃ nh vi giáº£i mÃ£ Ä‘á»™ng: chÆ°Æ¡ng trÃ¬nh gá»i `VirtualAlloc` / `VirtualAllocEx` nhiá»u láº§n vÃ  cáº¥p vÃ¹ng nhá»› cÃ³ quyá»n **ERW** (Execute + Read + Write). Hai vÃ¹ng Ä‘Ã¡ng chÃº Ã½ Ä‘Æ°á»£c cáº¥p:

  - `Address = 0x01170000` â€” Size â‰ˆ 0x35000 â€” PROT = ERW
  - `Address = 0x011C0000` â€” Size â‰ˆ 0x35000 â€” PROT = ERW

- Dump vÃ¹ng nhá»› thá»© hai (0x011C0000) báº±ng ProcessHacker (vÃ¬ vÃ¹ng 1 chá»‰ chá»©a data táº¡m) vÃ  lÆ°u ra file dump Ä‘á»ƒ phÃ¢n tÃ­ch tiáº¿p.
  ![Process Hacker dump](/resources/Sample-bin/Pasted%20image%2020251001164403.png)

> Báº¡n táº¡m dá»«ng á»Ÿ Ä‘Ã¢y vÃ¬ bÆ°á»›c deobfuscate/decode script tá»« vÃ¹ng nhá»› sáº½ ráº¥t tá»‘n thá»i gian â€” tÃ´i sáº½ tiáº¿p tá»¥c pháº§n nÃ y trong tÃ i liá»‡u dÆ°á»›i, nÃªu cÃ¡c bÆ°á»›c tiáº¿p theo vÃ  cÃ¡ch tiáº¿p cáº­n chi tiáº¿t.

---

## ğŸ”§ Pháº§n tiáº¿p theo (hÆ°á»›ng dáº«n chi tiáº¿t â€” cÃ¡ch lÃ m Ä‘á»ƒ hoÃ n táº¥t phÃ¢n tÃ­ch)

DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c bÆ°á»›c tiáº¿p theo nÃªn lÃ m (cÃ³ thá»ƒ báº¡n Ä‘Ã£/perhaps muá»‘n lÃ m tiáº¿p):

### 1) Chuáº©n bá»‹ cÃ¡c artifact dump
- Äáº·t tÃªn file dump rÃµ rÃ ng khi dump vÃ¹ng nhá»› (vÃ­ dá»¥):
  - `sample_mem_01170000.bin`
  - `sample_mem_011C0000.bin`
- LÆ°u kÃ¨m metadata: PID, timestamp, base address, size, tool (ProcessHacker/WinDbg).

### 2) PhÃ¢n tÃ­ch dump (statical / strings / x86 disasm)
- Cháº¡y `strings -a -el` trÃªn dump Ä‘á»ƒ tÃ¬m chuá»—i UTF-16/ASCII cÃ³ Ã½ nghÄ©a (URL, domain, IP, API, javascript/html templates).
- DÃ¹ng `binwalk` / `foremost` / `scalpel` Ä‘á»ƒ dÃ² xem trong dump cÃ³ file nhÃºng (PE, ZIP, HTML, PNG...)
- Load dump vÃ o IDA / Ghidra vÃ  tÃ¬m cÃ¡c entry code (Ä‘á»‹a chá»‰ chá»©a nhiá»u opcodes tÆ°Æ¡ng tá»± mÃ£ mÃ¡y). Náº¿u dump chá»©a shellcode, dÃ¹ng Linear Disassembler Ä‘á»ƒ disasm báº¯t Ä‘áº§u tá»« offsets cÃ³ nhiá»u `0xE8/0xFF` (call/jmp patterns).

### 3) Giáº£i mÃ£ chuá»—i ghÃ©p trong AutoIt
- Má»Ÿ `sample_.au3` (decompiled script). TÃ¬m hÃ m `mdfzjnyhbr()` â€” Ä‘Ã¢y lÃ  "string builder" hoáº·c unpacker.
- CÃ¡ch tiáº¿p cáº­n:
  1. Thá»±c hiá»‡n **Ä‘oáº¡n script trong mÃ´i trÆ°á»ng AutoIt** an toÃ n (sandbox) vÃ  log biáº¿n `$j` sau má»—i láº§n ná»‘i Ä‘á»ƒ xem káº¿t quáº£ tá»«ng bÆ°á»›c (chÃº Ã½: script cÃ³ thá»ƒ thá»±c thi code nguy hiá»ƒm â€” chá»‰ cháº¡y trÃªn VM cÃ´ láº­p khÃ´ng káº¿t ná»‘i máº¡ng).
  2. Náº¿u khÃ´ng muá»‘n cháº¡y, **dá»‹ch ngÆ°á»£c thuáº­t toÃ¡n ná»‘i**: chuyá»ƒn hÃ m deobfuscator sang Python vÃ  cháº¡y offline trÃªn dump hoáº·c trÃªn ná»™i dung RCData. (ThÆ°á»ng AutoIt obfuscators dÃ¹ng XOR/ROT/BASE64/concat patterns â€” cÃ³ thá»ƒ dá»‹ch Ä‘Æ°á»£c).
  3. Náº¿u chuá»—i ghÃ©p ráº¥t dÃ i, kiá»ƒm tra xem cÃ³ pattern mÃ£ hoÃ¡ block (vÃ­ dá»¥ má»—i láº§n ná»‘i thá»±c cháº¥t lÃ  decrypt block báº±ng key) â€” tÃ¡ch block vÃ  thá»­ cÃ¡c phÃ©p toÃ¡n XOR/xor key bruteforce nhá».

### 4) TÃ¬m C2 / IOC trong payload Ä‘Ã£ giáº£i mÃ£
- Sau khi giáº£i mÃ£ ná»™i dung script hoáº·c shellcode, search cÃ¡c pattern sau: `http://`, `https://`, `GET `, `POST `, IP addresses, domain names, registry keys, filenames, mutex names.
- Ghi láº¡i IOC: domains, IPs, drop file names, registry keys, autorun entries, mutexes.

### 5) Náº¿u dump chá»©a PE (giai Ä‘oáº¡n 2 payload)
- If you find a PE, try to reconstruct and load into IDA for static analysis. Náº¿u PE bá»‹ packed, thá»­ unpack báº±ng UPX / manual unpacking (Scylla) hoáº·c báº±ng cÃ¡ch emulation.

### 6) Dynamic tracing (náº¿u cáº§n)
- Äáº·t breakpoint vÃ o Ä‘á»‹a chá»‰ virtualAlloc return â†’ theo dÃµi write into the allocated regions (WriteProcessMemory/WriteFile).
- Theo dÃµi CreateRemoteThread / VirtualProtect calls â€” Ä‘Ã¢y thÆ°á»ng lÃ  dáº¥u hiá»‡u shellcode Ä‘Æ°á»£c viáº¿t rá»“i chuyá»ƒn sang execute.

### 7) Táº¡o indicators & YARA
- Khi tÃ¬m Ä‘Æ°á»£c strings/doms/IOCs, táº¡o YARA rules vÃ  signatures Ä‘á»ƒ quÃ©t táº­p máº«u lá»›n hÆ¡n.

---

## ğŸ§¾ Nhá»¯ng phÃ¡t hiá»‡n táº¡m thá»i & káº¿t luáº­n

- **Loáº¡i:** AutoIt executable chá»©a script lá»›n trong resources â†’ AutoIt-based backdoor/downloader.
- **Anti-analysis:** Kiá»ƒm tra debugger (`IsDebuggerPresent`) â†’ program thoÃ¡t náº¿u bá»‹ debug; báº¡n Ä‘Ã£ bypass báº±ng cÃ¡ch sá»­a tráº£ vá» 0.
- **Runtime unpack:** DÃ¹ng `VirtualAlloc` Ä‘á»ƒ cáº¥p vÃ¹ng ERW, kháº£ nÄƒng giáº£i mÃ£ code/strings vÃ o Ä‘Ã³ â†’ cho tháº¥y Ä‘á»™ng cÆ¡ load-and-execute (shellcode hoáº·c mÃ£ AutoIt Ä‘Ã£ decode).
- **Dump vÃ¹ng nhá»› 0x011C0000** Ä‘Ã£ Ä‘Æ°á»£c táº¡o â€” Ä‘Ã¢y lÃ  artifact quan trá»ng Ä‘á»ƒ tiáº¿p tá»¥c deobfuscate.
- **Tiáº¿p tá»¥c cáº§n lÃ m:** giáº£i mÃ£ hÃ m ná»‘i (mdfzjnyhbr), phÃ¢n tÃ­ch dump (tÃ¬m C2/strings) vÃ  xem payload thá»© cáº¥p.

---

## ğŸ“Œ IOC táº¡m thá»i (chÆ°a Ä‘áº§y Ä‘á»§ â€” cáº­p nháº­t khi giáº£i mÃ£ xong)

| Loáº¡i              | GiÃ¡ trá»‹                                                      |
| ----------------- | ------------------------------------------------------------ |
| File name         | `sample.bin`                                                 |
| MD5               | `66f33597cbf097345c51891ab951b641`                           |
| Type              | AutoIt executable (embedded script)                          |
| Notable functions | `mdfzjnyhbr()` (obfuscator / string builder)                 |
| Anti-debug        | `IsDebuggerPresent` hit at `sub_403b3a` (file offset 0x2F7A) |
| Memory regions    | Alloc ERW at `0x01170000`, `0x011C0000` (dump second region) |

> **ChÃº Ã½:** Nhá»¯ng IOC liÃªn quan tá»›i domain/IP chÆ°a rÃµ rÃ ng â€” pháº£i tá»« ná»™i dung Ä‘Ã£ giáº£i mÃ£.

---

## ğŸ›¡ï¸ Khuyáº¿n nghá»‹ kháº©n cáº¥p (Ä‘á»‘i vá»›i SOC / IR)

1. Náº¿u phÃ¡t hiá»‡n file nÃ y trong tá»• chá»©c: **CÃ¡ch ly mÃ¡y**, thu tháº­p memory dump & network capture.
2. Block kháº£ nghi: outbound báº¥t thÆ°á»ng tá»« host tá»›i domain / IP má»›i ná»•i (sau khi cÃ³ thÃ´ng tin domain sáº½ cáº­p nháº­t).
3. QuÃ©t há»‡ thá»‘ng tÃ¬m cÃ¡c file AutoIt tÆ°Æ¡ng tá»± (exe chá»©a `.rdata`/.rsrc` lá»›n), kiá»ƒm tra Run keys / scheduled tasks.
4. Náº¿u Ä‘Ã£ cÃ³ dump vÃ¹ng nhá»›, tiáº¿n hÃ nh static analysis offline Ä‘á»ƒ láº¥y C2 vÃ  cÃ¡c chá»‰ thá»‹ (commands).
5. Náº¿u khÃ´ng cÃ³ ká»¹ nÄƒng unpack/deobfuscate â€” gá»­i artifact lÃªn Ä‘á»™i pháº£n á»©ng chuyÃªn sÃ¢u hoáº·c malware lab.

---

## ğŸ” Gá»£i Ã½ cÃ´ng cá»¥ & lá»‡nh hay dÃ¹ng

- `exe2aut` â†’ decompile AutoIt executable â†’ `sample_.au3`
- `strings -a -el sample_mem_011C0000.bin`
- `binwalk` / `foremost` / `rabin2` / `radare2` (quick carving)
- IDA Pro / Ghidra cho disasm dump
- x32dbg / WinDbg / ProcessHacker / ProcMon / Regshot cho dynamic tracing
- Python (script deobfuscator) Ä‘á»ƒ emulate hÃ m ná»‘i `$j = $j & "...";` vÃ  reconstruct strings

---

> {: .prompt-info}
> **Máº¹o ghi nhá»›**
> HÃ¬nh dung quy trÃ¬nh nhÆ° sau:
> - **AutoIt exe** giá»‘ng má»™t cÃ¡i â€œhá»™p quÃ â€ cÃ³ _thÆ° má»¥c bÃ­ máº­t_ (resources .rdata/.rsrc).
> - **exe2aut** lÃ  cÃ¡i kÃ¬m Ä‘á»ƒ má»Ÿ há»™p ra (láº¥y `sample_.au3`).
> - **HÃ m mdfzjnyhbr()** lÃ  cuá»™n bÄƒng keo: nÃ³ dÃ¡n tá»«ng máº£nh chá»¯ vÃ o nhau Ä‘á»ƒ che ná»™i dung thá»±c. Muá»‘n tÃ¡ch ra thÃ¬ hÃ£y cáº¯t tá»«ng máº£nh (dump vÃ¹ng nhá»› hoáº·c cháº¡y Ä‘oáº¡n deobfuscator offline) â€” ghÃ©p láº¡i ta sáº½ tháº¥y bá»©c tranh (C2 / lá»‡nh).
> - **VirtualAlloc â†’ vÃ¹ng ERW** giá»‘ng cÃ¡i bÃ n thao tÃ¡c mÃ  malware dÃ¹ng Ä‘á»ƒ â€œkhÃ¢uâ€ mÃ£ Ä‘Ã£ giáº£i mÃ£ vÃ  báº­t nÃ³ cháº¡y. Dump cÃ¡i bÃ n nÃ y Ä‘á»ƒ láº¥y thÃ nh pháº§n thá»±c thi.

---

### Káº¿t luáº­n ngáº¯n
Báº¡n Ä‘Ã£ tá»›i Ä‘Ãºng chá»—: bypass anti-debug, tÃ¬m ra nÆ¡i malware giáº£i mÃ£ vÃ o bá»™ nhá»› vÃ  dump vÃ¹ng chá»©a payload. BÆ°á»›c tiáº¿p theo lÃ  **phÃ¢n tÃ­ch dump** vÃ  **dá»‹ch hÃ m ná»‘i trong `sample_.au3`** Ä‘á»ƒ lá»™ IOC / C2. Náº¿u báº¡n muá»‘n, tÃ´i sáº½:

- (A) Viáº¿t script Python mÃ´ phá»ng hÃ m `mdfzjnyhbr()` Ä‘á»ƒ giáº£i mÃ£ chuá»—i tá»« `sample_.au3` (náº¿u báº¡n paste Ä‘oáº¡n hÃ m Ä‘Ã³), **hoáº·c**
- (B) PhÃ¢n tÃ­ch file dump `sample_mem_011C0000.bin` (náº¿u báº¡n upload) vÃ  tÃ³m táº¯t káº¿t quáº£ (chuá»—i, PE embedded, C2).

Báº¡n chá»n A hay B â€” tÃ´i sáº½ báº¯t tay lÃ m luÃ´n pháº§n phÃ¢n tÃ­ch tiáº¿p theo dá»±a trÃªn lá»±a chá»n Ä‘Ã³ vÃ  dá»¯ liá»‡u báº¡n cung cáº¥p.
