---
title: AutoIt Backdoor
date: 2025-09-15 16:30:00 +0700
categories: [Malware, Analysis]
tags: [autoit, backdoor, trojan, unpacking, debugging]
description: Phân tích tĩnh và động mẫu AutoIt Backdoor (Trojan.Agent.Wacatac) – từ nhận diện AutoIt script, bypass anti-debug, theo dõi VirtualAlloc và dump payload.
---

## 📌 Bước 1: Thông tin cơ bản

- **File Name**: `sample.bin`
- **File type**: Executable AutoIt
- **MD5**: `66f33597cbf097345c51891ab951b641`
- **VirusTotal**: Phát hiện là dạng *Backdoor, Trojan.Agent.Wacatac*

📸

![VirusTotal detection](/resources/sample_autoit/Pasted image 20251001150856.png)

---

## 📌 Bước 2: Kiểm tra bằng Exeinfo PE

Kết quả nhận dạng:

- GUI, 32-bit
- Định danh AutoIt

📸

![Exeinfo PE](/resources/sample_autoit/Pasted image 20251001151054.png)

---

## 📌 Bước 3: Phân tích tĩnh với PeStudio

### 🧭 1. Indicators

📸

![PeStudio Indicators](/resources/sample_autoit/Pasted%20image%2020251001152108.png)

Các cảnh báo **Level 1** đáng chú ý:

- `file > embedded,signature: AutoIt` (trong `.rdata` và `.rsrc`)
- Gọi nhiều thư viện hệ thống:
  - Windows Socket 32-Bit Library
  - Windows Management Library
  - Multiple Provider Router Library
  - Internet Extensions for Win32 Library
  - Process Status Library
  - IP Helper API
- Số lượng imports cao: **161**

👉 Điều này gợi ý mẫu này có khả năng giao tiếp mạng, quản lý tiến trình, và đã bị **pack bằng AutoIt**.

---

### 🧭 2. Resource section

📸

![PeStudio Resources](/resources/sample_autoit/Pasted%20image%2020251001152224.png)

Trong `RCData` có **script AutoIt** chứa **signature đặc trưng** → đây chính là payload gốc đã được đóng gói vào resource.

---

## 📌 Bước 4: Giải nén AutoIt Script bằng Exe2Aut

Sử dụng công cụ `exe2aut` để decompile file AutoIt, kết quả thu được file `sample_.au3`.
Mở bằng Notepad++ → nội dung là **một script dài** với nhiều hàm và lệnh.

📸

![Script AutoIt giải nén](/resources/sample_autoit/Pasted%20image%2020251001152806.png)

Đặc biệt, có hàm `mdfzjnyhbr()` với hàng loạt phép nối `&` trên biến `$j`:

📸

![Hàm mã hóa chuỗi](/resources/sample_autoit/Pasted%20image%2020251001153616.png)

👉 Đây là kỹ thuật **obfuscation chuỗi**, giúp mã độc tránh bị đọc dễ dàng.

---

## 📌 Bước 5: Phân tích động với IDA + x32dbg

Do không có nhiều chuỗi rõ ràng, ta chuyển sang cách tiếp cận **theo dõi API khả nghi**.
Một trong những API đầu tiên malware hay gọi là `IsDebuggerPresent` để phát hiện môi trường debug.

📸

![IsDebuggerPresent](/resources/sample_autoit/Pasted%20image%2020251001155457.png)

API này nằm tại `sub_403B3A` – **file offset 0x2F7A**.
Đặt breakpoint tại đây trong x32dbg → khi chạy:

📸

![BP IsDebuggerPresent](/resources/sample_autoit/Pasted%20image%2020251001161251.png)

- Giá trị trả về = 1 → **chương trình phát hiện debugger** và thoát.
- Sửa kết quả trả về thành `0` để **bypass anti-debug**.

---

## 📌 Bước 6: Theo dõi VirtualAlloc để tìm payload

Sau khi bypass, malware tự giải mã chính nó → ta theo dõi `VirtualAlloc` / `VirtualAllocEx`:

- **Lần 1**
  - Trả về địa chỉ: `0x01170000`
  - Quyền: `ERW` (Executable + Readable + Writable)
  - Size: `0x00035000`

Address=01170000
Size=00035000
Party=User
Allocation Type=PRV
Current Protection=ERW


- **Lần 2**
  - Trả về địa chỉ: `0x011C0000`
  - Quyền tương tự như lần 1

📸
![Memory Dump vùng 2](/resources/sample_autoit/Pasted%20image%2020251001164403.png)

👉 Đây là các vùng chứa **payload sau khi giải mã**.

---

## 📌 Bước 7: Dump Payload

Dùng **Process Hacker** để dump toàn bộ vùng nhớ thứ 2 (`0x011C0000`) ra file mới.
→ Vùng này chứa payload chính, có thể tiếp tục phân tích sâu hơn (unpacking, PE reconstruction, v.v.)

Do mức độ phức tạp cao → bài này tạm dừng tại bước dump để tập trung vào giai đoạn giải mã & bypass.

---

## ✅ Kết luận

- Mẫu `sample.bin` là **AutoIt-packed trojan/backdoor**, có nhiều hành vi khả nghi liên quan đến mạng và quản lý tiến trình.
- **PeStudio** và **Exeinfo PE** giúp nhận dạng nhanh định dạng AutoIt.
- **Exe2Aut** cho phép lấy được script gốc nhưng đã bị obfuscate chuỗi.
- **Debug với x32dbg** và **theo dõi API** (IsDebuggerPresent, VirtualAlloc) giúp bypass anti-debug & tìm được vùng giải mã.
- Dump vùng nhớ giúp có thể tiếp tục phân tích sâu hơn (malware unpacking nâng cao).

---

## 🔗 Ghi chú thêm

- AutoIt thường được dùng để **đóng gói payload khác** (dropper/loader).
- Các bước như trên có thể áp dụng cho nhiều mẫu AutoIt tương tự.
- Có thể sử dụng thêm Scylla hoặc x64dbg plugin để reconstruct PE từ vùng nhớ dump.

---
