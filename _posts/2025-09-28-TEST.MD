---
title: TEST
date: 2025-09-28 01:01:01 +0700
categories: [PWN, LT]
tags: [lt]     # TAG names should always be lowercase
author: john_doe
description: Hướng dẫn cách tạo bài viết mới trong template Chirpy, từ đặt tên, tạo file đến thêm mô tả, tác giả, bình luận...
---


Ok, tóm gọn – trong WinAPI việc lấy resource đi theo **3 “tầng” khác nhau**. Mỗi tầng dùng **một loại handle/con trỏ khác nhau**:


          `(1) tra cứu           (2) nạp/map            (3) lấy con trỏ .rc  ──> FindResource ──HRSRC──> LoadResource ──HGLOBAL──> LockResource ──> LPVOID (ptr)                                    ▲                                    └─ SizeofResource(hModule, HRSRC) đọc kích thước từ metadata`

## Giải thích từng cái (ngắn – dễ nhớ)
1. **HRSRC (FindResource)**
    - “Phiếu gửi đồ” (metadata) trong cây `.rsrc`: type, name, RVA, **size**…
    - **Chưa có dữ liệu** để bạn đọc.
    - Dùng HRSRC cho: **`SizeofResource`** (vì kích thước nằm trong metadata này).
2. **HGLOBAL (LoadResource)**
    - “Túi đồ” đã được **nạp/map** sẵn bởi hệ thống từ image.
    - Vẫn **chưa** là con trỏ bytes bạn thao tác trực tiếp.
3. **LPVOID (LockResource)**
    - “Mở túi” → trả về **con trỏ read‑only tới byte đầu** của resource.
    - Đây mới là cái bạn dùng `memcpy`, `fwrite`, parse…
    - Không cần `UnlockResource`; `FreeResource` đã lỗi thời.
4. **`SizeofResource(hModule, HRSRC)`**
    - Tại sao không cần HGLOBAL/LPVOID? Vì **kích thước đã có sẵn trong entry metadata** (tầng HRSRC).
    - Nó đọc số byte “đã đóng gói” của resource, **không phụ thuộc** vào việc bạn đã `LoadResource`/`LockResource` hay chưa.

# 2. Chung
Không chỉ resource — **rất nhiều WinAPI đi theo “mẫu” (pattern) cố định** về handle/con trỏ. Nếu bạn nắm được pattern thì nhìn hàm là đoán được “nó ở tầng nào”. Dưới đây là **cheat‑sheet** gọn để bạn soi nhanh (kiểu sơ đồ như lúc nãy).

## Mẫu chung (3–4 tầng)


`(1) Tìm/mở (descriptor)   →  (2) Nạp/ánh xạ (handle/map)  →  (3) Lấy con trỏ/tra cứu (ptr/info)  →  (4) Giải phóng Find/Open/Lookup             Load/Map/Create                 Lock/MapView/Get*                        Close/Delete/Unmap`

- **Tầng (1)**: trả về _handle mô tả_ (metadata/khóa/kênh).
- **Tầng (2)**: đưa tài nguyên vào trạng thái dùng được (đã “mở túi”).
- **Tầng (3)**: lấy **con trỏ/bytes/thông tin** để thao tác thực.
- **Size/Length** thường đọc từ **descriptor** (tầng 1) hoặc qua hàm `Get*Information`.


# Bản đồ nhanh cho các nhóm API hay gặp

1. **Resource (.rsrc)**

`FindResource → HRSRC (descriptor, có size)  LoadResource → HGLOBAL (data block) LockResource → LPVOID (ptr read‑only) SizeofResource(hMod, HRSRC) → DWORD // Không cần FreeResource; sống tới khi module unload`

**File mapping (đọc file vào memory)**
`CreateFile → HANDLE file CreateFileMapping → HANDLE mapping MapViewOfFile → LPVOID (ptr) UnmapViewOfFile / CloseHandle`

2. **Process memory & injection**

`OpenProcess → HANDLE process VirtualAllocEx → LPVOID (addr remote) WriteProcessMemory → BOOL (ghi bytes) CreateRemoteThread → HANDLE thread CloseHandle (các handle)`

3. **Registry**

RegOpenKeyEx → HKEY
RegQueryValueEx → size + data
RegCloseKey`

4. **GDI object (bitmap/pen/brush)**

Create* → HBITMAP/HPEN/HBRUSH
SelectObject(hdc, hObj)  // dùng
DeleteObject(hObj)       // giải phóng`

5. **Icon/Cursor/Bitmap “chuẩn” (không cần generic)**

`LoadImage / LoadIcon / LoadCursor → HICON/HCURSOR/HBITMAP
DestroyIcon / DestroyCursor / DeleteObject`

6. **String resource**

`LoadString(hMod, id, buf, cch) → int (số ký tự)`

# Cách tự “đọc vị” hàm WinAPI

- **Tên hàm nói lên tầng**:
    - `Find*/Open*/Lookup*` → **descriptor/handle mô tả** (chưa có dữ liệu).
    - `Load*/Create*/Map*` → **đưa vào trạng thái dùng được** (đã nạp/ánh xạ).
    - `Lock*/MapView*/Get*` → **lấy con trỏ/bytes/thông tin**.
    - `Sizeof*/Get*Information` → **độ dài/thông tin** từ descriptor.
    - `CloseHandle/DeleteObject/UnmapView/Destroy*` → **kết thúc vòng đời**.
- **Kiểu trả về gợi ý luôn**:
    - `HRSRC/HGLOBAL/HMODULE/HANDLE` = _handle/descriptor_.
    - `LPVOID/LPBYTE/char*/wchar_t*` = _con trỏ dữ liệu_.
    - `DWORD/SIZE_T` = _kích thước_.
- **Đối xứng giải phóng**:
    - `CloseHandle` cho kernel objects (file, process, thread, mapping…).
    - `DeleteObject` cho GDI.
    - `DestroyIcon/DestroyCursor`, `UnmapViewOfFile`, v.v.
    - Resource generic **không** cần free (đã map trong image).

# Mẹo ghi nhớ

- **Phiếu – Túi – Con trỏ – Cân nặng**:
    _Find/Open_ (phiếu) → _Load/Map_ (túi) → _Lock/MapView/Get_ (con trỏ) → _Size/GetInfo_ (cân nặng).

- Nếu **không chắc loại** → dùng **generic 4 bước** (như resource RCDATA).
    Nếu là **đối tượng UI chuẩn** (ICON, MENU, DIALOG…) → ưu tiên **API chuyên dụng**.

# Có thể đọc trong msdn nhưng khó hiểu hơn
