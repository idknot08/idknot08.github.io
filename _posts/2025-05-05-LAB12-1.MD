---

title: Lab12-1 : Practical Malware Analysis

date: 2025-05-25 01:01:01 +0700

categories: [PWN, Partical]

tags: [Partical]     # TAG names should always be lowercase

author : john_doe

description: Hướng dẫn cách tạo bài viết mới trong template Chirpy, từ đặt tên, tạo file đến thêm mô tả, tác giả, bình luận...

---



# **Câu 1. Phân tích hành vi: Nạp DLL vào tiến trình `explorer.exe`**



---



## **1. Phân tích cấu trúc file thực thi (.exe)**



### 🔍 **1.1 Sử dụng PE-bear**



* Kiểm tra tổng quan cấu trúc PE file của chương trình.

* Xác định được file là một PE32, có entrypoint hợp lệ, không bị pack/obfuscate.



📸 *Hình minh họa từ PE-bear:*

![[Pasted image 20250924080625.png]]



---



### 🔍 **1.2 Sử dụng PeStudio**



* Kiểm tra IAT (Import Address Table), phát hiện các hàm API thường được sử dụng trong kỹ thuật **DLL injection**:



  * `OpenProcess`: Lấy handle tới tiến trình mục tiêu (`explorer.exe`), thường yêu cầu quyền `PROCESS_VM_WRITE` và `PROCESS_CREATE_THREAD`.

  * `VirtualAllocEx`: Cấp phát bộ nhớ trong tiến trình mục tiêu.

  * `WriteProcessMemory`: Ghi nội dung DLL vào vùng nhớ vừa cấp phát.

  * `VirtualProtectEx`: Thay đổi quyền thực thi của vùng nhớ từ RW → RX.

  * `CreateRemoteThread`: Tạo luồng từ tiến trình khác để khởi chạy shellcode/DLL.



🧩 **Luồng thực hiện tiêm DLL điển hình:**



```

OpenProcess

→ VirtualAllocEx

→ WriteProcessMemory

→ VirtualProtectEx

→ CreateRemoteThread

```



📸 *Ảnh minh họa IAT và hành vi từ PeStudio:*

![[Pasted image 20250924075752.png]]

![[Pasted image 20250924075850.png]]



⚠️ Một số kỹ thuật bị PeStudio gắn cờ là **"suspicious"** (đáng ngờ) — ví dụ `CreateRemoteThread`.



---



## **2. Phân tích hành vi của file DLL**



### 🛠 **2.1 Sử dụng IDA Pro phân tích Lab12-01.dll**



* Dò tìm chuỗi `"Practical Malware Analysis %d"` → xác định được **entry point thực thi chính**.

* Trong hàm chính: chương trình gọi `CreateThread` để tạo luồng mới.

* Hàm `StartAddress` trong luồng chứa lời gọi `MessageBoxA` → hiển thị hộp thoại cảnh báo.



📸 *Ảnh phân tích chuỗi và mã lệnh trong IDA:*

![[Pasted image 20250924080044.png]]

![[Pasted image 20250924083754.png]]



---



## **3. Phân tích tiến trình `.exe` mục tiêu**



### 🔍 **3.1 Tìm kiếm chuỗi tĩnh (static strings)**



* Dùng chức năng “**Strings**” trong IDA để tìm kiếm các chuỗi `.exe` khả nghi → phát hiện `"explorer.exe"`.

* Theo dõi cross-references (xref) để truy ngược đến đoạn mã sử dụng chuỗi.



📸 *Ảnh strings và xref trong IDA:*

![[Pasted image 20250924081911.png]]

![[Pasted image 20250924084151.png]]



---



### 🔎 **3.2 Phân tích logic kiểm tra tiến trình explorer.exe**



* Trong hàm `sub_401000`, mã thực thi kiểm tra xem `explorer.exe` có đang chạy không.

* Nếu có, thực hiện các bước:



  * Cấp phát bộ nhớ trong `explorer.exe`

  * Ghi DLL vào đó

  * Tạo luồng để thực thi



📸 *Ảnh mã kiểm tra tiến trình và injection:*

![[Pasted image 20250924084434.png]]



---



## **4. Cách xử lý/kết thúc tiến trình bị tiêm**



### 🛑 **Cách 1: Dùng Task Manager**



* Mở Task Manager → kết thúc tiến trình `explorer.exe`.



📸

![[Win2008-NETLAB-2025-09-24-08-51-42.png]]



---



### 🛠 **Cách 2: Dùng Process Hacker**



* Tìm và kết thúc luồng (`thread`) của DLL `Lab12-01.dll` trong tiến trình `explorer.exe`.



📸

![[Pasted image 20250924090136.png]]



---



## **5. Tổng kết hành vi**



* **Mã độc sử dụng kỹ thuật Reflective DLL Injection** để nạp DLL `Lab12-01.dll` vào tiến trình `explorer.exe`.

* Sau khi tiêm, DLL **hiển thị hộp thoại** với nội dung chứa chuỗi `"Practical Malware Analysis %d"`.

* Trong mã có sử dụng `Sleep(60000)` → **delay 60 giây** trước hoặc sau khi thực thi hành vi chính.



📸 *Hàm Sleep trong IDA:*

![[Pasted image 20250924090704.png]]



---
