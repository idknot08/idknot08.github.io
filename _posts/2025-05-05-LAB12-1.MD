---

title: Lab12-1 : Practical Malware Analysis

date: 2025-05-25 01:01:01 +0700

categories: [PWN, Partical]

tags: [Partical] Â  Â  # TAG names should always be lowercase

author : john_doe

description: HÆ°á»›ng dáº«n cÃ¡ch táº¡o bÃ i viáº¿t má»›i trong template Chirpy, tá»« Ä‘áº·t tÃªn, táº¡o file Ä‘áº¿n thÃªm mÃ´ táº£, tÃ¡c giáº£, bÃ¬nh luáº­n...

---



# **CÃ¢u 1. PhÃ¢n tÃ­ch hÃ nh vi: Náº¡p DLL vÃ o tiáº¿n trÃ¬nh `explorer.exe`**



---



## **1. PhÃ¢n tÃ­ch cáº¥u trÃºc file thá»±c thi (.exe)**



### ğŸ” **1.1 Sá»­ dá»¥ng PE-bear**



* Kiá»ƒm tra tá»•ng quan cáº¥u trÃºc PE file cá»§a chÆ°Æ¡ng trÃ¬nh.

* XÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c file lÃ  má»™t PE32, cÃ³ entrypoint há»£p lá»‡, khÃ´ng bá»‹ pack/obfuscate.



ğŸ“¸ *HÃ¬nh minh há»a tá»« PE-bear:*

![[Pasted image 20250924080625.png]]



---



### ğŸ” **1.2 Sá»­ dá»¥ng PeStudio**



* Kiá»ƒm tra IAT (Import Address Table), phÃ¡t hiá»‡n cÃ¡c hÃ m API thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong ká»¹ thuáº­t **DLL injection**:



Â  * `OpenProcess`: Láº¥y handle tá»›i tiáº¿n trÃ¬nh má»¥c tiÃªu (`explorer.exe`), thÆ°á»ng yÃªu cáº§u quyá»n `PROCESS_VM_WRITE` vÃ  `PROCESS_CREATE_THREAD`.

Â  * `VirtualAllocEx`: Cáº¥p phÃ¡t bá»™ nhá»› trong tiáº¿n trÃ¬nh má»¥c tiÃªu.

Â  * `WriteProcessMemory`: Ghi ná»™i dung DLL vÃ o vÃ¹ng nhá»› vá»«a cáº¥p phÃ¡t.

Â  * `VirtualProtectEx`: Thay Ä‘á»•i quyá»n thá»±c thi cá»§a vÃ¹ng nhá»› tá»« RW â†’ RX.

Â  * `CreateRemoteThread`: Táº¡o luá»“ng tá»« tiáº¿n trÃ¬nh khÃ¡c Ä‘á»ƒ khá»Ÿi cháº¡y shellcode/DLL.



ğŸ§© **Luá»“ng thá»±c hiá»‡n tiÃªm DLL Ä‘iá»ƒn hÃ¬nh:**



```

OpenProcess

â†’ VirtualAllocEx

â†’ WriteProcessMemory

â†’ VirtualProtectEx

â†’ CreateRemoteThread

```



ğŸ“¸ *áº¢nh minh há»a IAT vÃ  hÃ nh vi tá»« PeStudio:*

![[Pasted image 20250924075752.png]]

![[Pasted image 20250924075850.png]]



âš ï¸ Má»™t sá»‘ ká»¹ thuáº­t bá»‹ PeStudio gáº¯n cá» lÃ  **"suspicious"** (Ä‘Ã¡ng ngá») â€” vÃ­ dá»¥ `CreateRemoteThread`.



---



## **2. PhÃ¢n tÃ­ch hÃ nh vi cá»§a file DLL**



### ğŸ›  **2.1 Sá»­ dá»¥ng IDA Pro phÃ¢n tÃ­ch Lab12-01.dll**



* DÃ² tÃ¬m chuá»—i `"Practical Malware Analysis %d"` â†’ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c **entry point thá»±c thi chÃ­nh**.

* Trong hÃ m chÃ­nh: chÆ°Æ¡ng trÃ¬nh gá»i `CreateThread` Ä‘á»ƒ táº¡o luá»“ng má»›i.

* HÃ m `StartAddress` trong luá»“ng chá»©a lá»i gá»i `MessageBoxA` â†’ hiá»ƒn thá»‹ há»™p thoáº¡i cáº£nh bÃ¡o.



ğŸ“¸ *áº¢nh phÃ¢n tÃ­ch chuá»—i vÃ  mÃ£ lá»‡nh trong IDA:*

![[Pasted image 20250924080044.png]]

![[Pasted image 20250924083754.png]]



---



## **3. PhÃ¢n tÃ­ch tiáº¿n trÃ¬nh `.exe` má»¥c tiÃªu**



### ğŸ” **3.1 TÃ¬m kiáº¿m chuá»—i tÄ©nh (static strings)**



* DÃ¹ng chá»©c nÄƒng â€œ**Strings**â€ trong IDA Ä‘á»ƒ tÃ¬m kiáº¿m cÃ¡c chuá»—i `.exe` kháº£ nghi â†’ phÃ¡t hiá»‡n `"explorer.exe"`.

* Theo dÃµi cross-references (xref) Ä‘á»ƒ truy ngÆ°á»£c Ä‘áº¿n Ä‘oáº¡n mÃ£ sá»­ dá»¥ng chuá»—i.



ğŸ“¸ *áº¢nh strings vÃ  xref trong IDA:*

![[Pasted image 20250924081911.png]]

![[Pasted image 20250924084151.png]]



---



### ğŸ” **3.2 PhÃ¢n tÃ­ch logic kiá»ƒm tra tiáº¿n trÃ¬nh explorer.exe**



* Trong hÃ m `sub_401000`, mÃ£ thá»±c thi kiá»ƒm tra xem `explorer.exe` cÃ³ Ä‘ang cháº¡y khÃ´ng.

* Náº¿u cÃ³, thá»±c hiá»‡n cÃ¡c bÆ°á»›c:



Â  * Cáº¥p phÃ¡t bá»™ nhá»› trong `explorer.exe`

Â  * Ghi DLL vÃ o Ä‘Ã³

Â  * Táº¡o luá»“ng Ä‘á»ƒ thá»±c thi



ğŸ“¸ *áº¢nh mÃ£ kiá»ƒm tra tiáº¿n trÃ¬nh vÃ  injection:*

![[Pasted image 20250924084434.png]]



---



## **4. CÃ¡ch xá»­ lÃ½/káº¿t thÃºc tiáº¿n trÃ¬nh bá»‹ tiÃªm**



### ğŸ›‘ **CÃ¡ch 1: DÃ¹ng Task Manager**



* Má»Ÿ Task Manager â†’ káº¿t thÃºc tiáº¿n trÃ¬nh `explorer.exe`.



ğŸ“¸

![[Win2008-NETLAB-2025-09-24-08-51-42.png]]



---



### ğŸ›  **CÃ¡ch 2: DÃ¹ng Process Hacker**



* TÃ¬m vÃ  káº¿t thÃºc luá»“ng (`thread`) cá»§a DLL `Lab12-01.dll` trong tiáº¿n trÃ¬nh `explorer.exe`.



ğŸ“¸

![[Pasted image 20250924090136.png]]



---



## **5. Tá»•ng káº¿t hÃ nh vi**



* **MÃ£ Ä‘á»™c sá»­ dá»¥ng ká»¹ thuáº­t Reflective DLL Injection** Ä‘á»ƒ náº¡p DLL `Lab12-01.dll` vÃ o tiáº¿n trÃ¬nh `explorer.exe`.

* Sau khi tiÃªm, DLL **hiá»ƒn thá»‹ há»™p thoáº¡i** vá»›i ná»™i dung chá»©a chuá»—i `"Practical Malware Analysis %d"`.

* Trong mÃ£ cÃ³ sá»­ dá»¥ng `Sleep(60000)` â†’ **delay 60 giÃ¢y** trÆ°á»›c hoáº·c sau khi thá»±c thi hÃ nh vi chÃ­nh.



ğŸ“¸ *HÃ m Sleep trong IDA:*

![[Pasted image 20250924090704.png]]



---
