---
title: Lab12-2 Practical Malware Analysis
date: 2025-05-26 10:00:00 +0700
categories: [RE, Partical]
tags: [keylogger]
description: PhÃ¢n tÃ­ch hÃ nh vi ghi phÃ­m vÃ  náº¡p payload thÃ´ng qua resource LOCALIZATION.
---

## **1. Quan sÃ¡t hÃ nh vi qua Procmon**

- **Tiáº¿n trÃ¬nh `Lab12-02.exe` táº¡o tiáº¿n trÃ¬nh con tÃªn `svchost.exe`**.
- Tiáº¿n trÃ¬nh `svchost.exe` táº¡o file `practicalmalwareanalysis.log`.

ğŸ“¸
![Procmon - create process](/resources/Lab12-2/Pasted image 20250924101204.png)

---

### âš ï¸ KhÃ´ng cÃ³ káº¿t ná»‘i máº¡ng

- Tiáº¿n trÃ¬nh **khÃ´ng cá»‘ gáº¯ng káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§ tá»« xa**.
- Chá»§ yáº¿u ghi **log tá»« bÃ n phÃ­m**.

ğŸ“¸
![Procmon - keylogger file activity](/resources/Lab12-2/Pasted image 20250924094736.png)
![Procmon - file detail](/resources/Lab12-2/Pasted image 20250924093818.png)
![Procmon - process tree](/resources/Lab12-2/Pasted image 20250924103258.png)
![Procmon - svchost log write](/resources/Lab12-2/Pasted image 20250924103555.png)

---

## **2. PhÃ¢n tÃ­ch tÃ i nguyÃªn (resource)**

- Cáº£nh bÃ¡o liÃªn quan Ä‘áº¿n vÃ¹ng tÃ i nguyÃªn `UNICODE:LOCALIZATION`.
- CÃ¡c chuá»—i kháº£ nghi cÅ©ng náº±m trong vÃ¹ng nÃ y.

ğŸ“¸
![PeStudio - Resource Warning](/resources/Lab12-2/Pasted image 20250924093950.png)
![PeStudio - String Issues](/resources/Lab12-2/Pasted image 20250924094138.png)

---

## **3. TrÃ­ch xuáº¥t payload vÃ  nháº­n diá»‡n**

- TrÃ­ch xuáº¥t tÃ i nguyÃªn `LOCALIZATION` â†’ láº¥y hash â†’ tra trÃªn VirusTotal.

ğŸ“¸
![VirusTotal Result](/resources/Lab12-2/Pasted image 20250924102859.png)

â†’ Nháº­n diá»‡n lÃ  **TrojanSpy.Keylogger** â†’ ÄÃ¢y lÃ  **payload chÃ­nh cá»§a chÆ°Æ¡ng trÃ¬nh**.

---

## **4. Theo dÃµi API liÃªn quan**

ğŸ“¸
![API call tree](/resources/Lab12-2/Pasted image 20250924105718.png)

---

## **5. CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng tá»•ng thá»ƒ**

- Táº¡o tiáº¿n trÃ¬nh `svchost.exe`, **náº¡p payload tá»« resource LOCALIZATION** vÃ o Ä‘Ã³.
- Payload thá»±c hiá»‡n **ghi phÃ­m (keylogging)**.

ğŸ“¸
![Tá»•ng quan luá»“ng thá»±c thi](/resources/Lab12-2/Pasted image 20250924114825.png)

---

## **6. TÃ¬m hÃ m táº¡o tiáº¿n trÃ¬nh**

- TÃ¬m tháº¥y `"svchost.exe"` Ä‘Æ°á»£c dÃ¹ng lÃ m tham sá»‘ trong `sub_40149D`.
- HÃ m nÃ y xÃ¢y dá»±ng **Ä‘Æ°á»ng dáº«n Ä‘áº¿n file svchost.exe** trong `system32`.

ğŸ“¸
![HÃ m táº¡o svchost.exe path](/resources/Lab12-2/Pasted image 20250924115000.png)

---

## **7. Náº¡p payload tá»« resource**

- DÃ¹ng combo API: `FindResourceA`, `LoadResource`, `LockResource` Ä‘á»ƒ truy cáº­p payload.

ğŸ“¸
![Náº¡p tá»« resource](/resources/Lab12-2/Pasted image 20250924134132.png)
![Lock resource](/resources/Lab12-2/Pasted image 20250924134359.png)
![TrÆ°á»›c khi giáº£i mÃ£](/resources/Lab12-2/Pasted image 20250924134524.png)

---

## **8. HÃ m giáº£i mÃ£ payload (sub_401000)**

- Giáº£i mÃ£ payload báº±ng **XOR** vá»›i **key = 0x41**.

ğŸ“¸
![Call sub_401000](/resources/Lab12-2/Pasted image 20250924134655.png)
![Debug EBP](/resources/Lab12-2/Pasted image 20250924142336.png)
![Debug XOR key](/resources/Lab12-2/Pasted image 20250924142359.png)

---

## **9. Giáº£i mÃ£ vÃ  phÃ¢n tÃ­ch payload**

- Giáº£i mÃ£ báº±ng XOR â†’ xuáº¥t ra file PE thá»±c thi.
- MD5 cá»§a payload: `a7f21e412022554d187d6a876a3c08ac`
- Nháº­n diá»‡n lÃ  **keylogger chÃ­nh**.

ğŸ“¸
![Payload giáº£i mÃ£](/resources/Lab12-2/Pasted image 20250924143107.png)
![Payload details](/resources/Lab12-2/Pasted image 20250924143130.png)
![Payload final hash](/resources/Lab12-2/Pasted image 20250924143434.png)

---

## **10. Tráº£ lá»i cÃ¢u há»i**

### 1. **Má»¥c Ä‘Ã­ch**
- **Ghi láº¡i bÃ n phÃ­m (keylogging)** nhÆ°ng **khÃ´ng gá»­i ná»™i dung ra ngoÃ i**.

---

### 2. **CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng**
1. Táº¡o tiáº¿n trÃ¬nh `svchost.exe` â†’ dá»«ng â†’ **náº¡p payload** vÃ o tiáº¿n trÃ¬nh há»£p lá»‡.
2. **Dá»n dáº¹p báº±ng `VirtualFree`**, cÃ³ delay giá»¯a cÃ¡c láº§n thá»±c thi.
3. Payload Ä‘Æ°á»£c **mÃ£ hÃ³a báº±ng XOR**.
4. CÆ¡ cháº¿ **cáº¥p phÃ¡t + thá»±c thi** lÃ  combo thÃ´ng thÆ°á»ng.
5. TÃ i nguyÃªn Ä‘Æ°á»£c náº¡p báº±ng:
   `FindResourceA` â†’ `LoadResource` â†’ `LockResource`.

---

### 3. **ThÃ´ng tin vá» resource**
- Payload lÆ°u trong resource tÃªn `LOCALIZATION`, dáº¡ng `UNICODE`.

---

### 4. **Giáº£i mÃ£**
- HÃ m giáº£i mÃ£ chÃ­nh: `sub_401000`, **key lÃ  tham sá»‘ thá»© 3**.

---

### 5. **Káº¿t quáº£**
- Payload Ä‘Æ°á»£c XOR vá»›i `0x41`, sau khi giáº£i mÃ£ lÃ  **file thá»±c thi** keylogger.

---

