---
title: Lab12-2 Practical Malware Analysis
date: 2025-05-26 10:00:00 +0700
categories: [RE, Partical]
tags: [keylogger]
description: Phân tích hành vi ghi phím và nạp payload thông qua resource LOCALIZATION.
---

## **1. Quan sát hành vi qua Procmon**

- **Tiến trình `Lab12-02.exe` tạo tiến trình con tên `svchost.exe`**.
- Tiến trình `svchost.exe` tạo file `practicalmalwareanalysis.log`.

📸
![Procmon - create process](/resources/Lab12-2/Pasted image 20250924101204.png)

---

### ⚠️ Không có kết nối mạng

- Tiến trình **không cố gắng kết nối đến máy chủ từ xa**.
- Chủ yếu ghi **log từ bàn phím**.

📸
![Procmon - keylogger file activity](/resources/Lab12-2/Pasted image 20250924094736.png)
![Procmon - file detail](/resources/Lab12-2/Pasted image 20250924093818.png)
![Procmon - process tree](/resources/Lab12-2/Pasted image 20250924103258.png)
![Procmon - svchost log write](/resources/Lab12-2/Pasted image 20250924103555.png)

---

## **2. Phân tích tài nguyên (resource)**

- Cảnh báo liên quan đến vùng tài nguyên `UNICODE:LOCALIZATION`.
- Các chuỗi khả nghi cũng nằm trong vùng này.

📸
![PeStudio - Resource Warning](/resources/Lab12-2/Pasted image 20250924093950.png)
![PeStudio - String Issues](/resources/Lab12-2/Pasted image 20250924094138.png)

---

## **3. Trích xuất payload và nhận diện**

- Trích xuất tài nguyên `LOCALIZATION` → lấy hash → tra trên VirusTotal.

📸
![VirusTotal Result](/resources/Lab12-2/Pasted image 20250924102859.png)

→ Nhận diện là **TrojanSpy.Keylogger** → Đây là **payload chính của chương trình**.

---

## **4. Theo dõi API liên quan**

📸
![API call tree](/resources/Lab12-2/Pasted image 20250924105718.png)

---

## **5. Cơ chế hoạt động tổng thể**

- Tạo tiến trình `svchost.exe`, **nạp payload từ resource LOCALIZATION** vào đó.
- Payload thực hiện **ghi phím (keylogging)**.

📸
![Tổng quan luồng thực thi](/resources/Lab12-2/Pasted image 20250924114825.png)

---

## **6. Tìm hàm tạo tiến trình**

- Tìm thấy `"svchost.exe"` được dùng làm tham số trong `sub_40149D`.
- Hàm này xây dựng **đường dẫn đến file svchost.exe** trong `system32`.

📸
![Hàm tạo svchost.exe path](/resources/Lab12-2/Pasted image 20250924115000.png)

---

## **7. Nạp payload từ resource**

- Dùng combo API: `FindResourceA`, `LoadResource`, `LockResource` để truy cập payload.

📸
![Nạp từ resource](/resources/Lab12-2/Pasted image 20250924134132.png)
![Lock resource](/resources/Lab12-2/Pasted image 20250924134359.png)
![Trước khi giải mã](/resources/Lab12-2/Pasted image 20250924134524.png)

---

## **8. Hàm giải mã payload (sub_401000)**

- Giải mã payload bằng **XOR** với **key = 0x41**.

📸
![Call sub_401000](/resources/Lab12-2/Pasted image 20250924134655.png)
![Debug EBP](/resources/Lab12-2/Pasted image 20250924142336.png)
![Debug XOR key](/resources/Lab12-2/Pasted image 20250924142359.png)

---

## **9. Giải mã và phân tích payload**

- Giải mã bằng XOR → xuất ra file PE thực thi.
- MD5 của payload: `a7f21e412022554d187d6a876a3c08ac`
- Nhận diện là **keylogger chính**.

📸
![Payload giải mã](/resources/Lab12-2/Pasted image 20250924143107.png)
![Payload details](/resources/Lab12-2/Pasted image 20250924143130.png)
![Payload final hash](/resources/Lab12-2/Pasted image 20250924143434.png)

---

## **10. Trả lời câu hỏi**

### 1. **Mục đích**
- **Ghi lại bàn phím (keylogging)** nhưng **không gửi nội dung ra ngoài**.

---

### 2. **Cơ chế hoạt động**
1. Tạo tiến trình `svchost.exe` → dừng → **nạp payload** vào tiến trình hợp lệ.
2. **Dọn dẹp bằng `VirtualFree`**, có delay giữa các lần thực thi.
3. Payload được **mã hóa bằng XOR**.
4. Cơ chế **cấp phát + thực thi** là combo thông thường.
5. Tài nguyên được nạp bằng:
   `FindResourceA` → `LoadResource` → `LockResource`.

---

### 3. **Thông tin về resource**
- Payload lưu trong resource tên `LOCALIZATION`, dạng `UNICODE`.

---

### 4. **Giải mã**
- Hàm giải mã chính: `sub_401000`, **key là tham số thứ 3**.

---

### 5. **Kết quả**
- Payload được XOR với `0x41`, sau khi giải mã là **file thực thi** keylogger.

---

